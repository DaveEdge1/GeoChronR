---
title: "Introduction to geoChronR -- Correlations"
author: "Nick McKay"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to geoChronR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  ---
  
  ### Welcome to geoChronR!
  
  ##Workflow 
  
  Almost always, your geoChronR work flow will start with loading in a valid LiPD file. So you'll want both the geoChronR and lipdR libraries
  
```{r}
library(lipdR)
library(geoChronR)
library(magrittr)
```

In this case, we're going to load in the Wang YEAR Hulu Cave dataset

```{r}
hulu <- readLipd(system.file("extdata", "Hulucave.Wang.2345.lpd", package = "geoChronR"))
```

Data from five stalagmites are stored in this file. Age model output, including ensemble data, can be stored in LiPD files, but we don't have that for this record. For this example we're going to use the original U/Th dates to create a new a model using BChron.


We're going to specify many of the parameters here for simplicity, but you can run this with just:

`hulu <- runBchron(L)`

and it will prompt you for the details.

```{r}
hulu <- runBchron(L,calCurves = "normal",iter = 10000,which.table = 2,interpolate = T,age14CVar = "age",age14CuncertaintyVar = "ageUncertaintyHigh",labIDVar = NULL,reject = F,ageVar = NULL,ageUncertaintyVar = NULL,rejectedAgesVar = NULL,extractDate = 10000)
```

OK, let's take a look at the model. 
```{r}
plotChron(hulu)
```

`plotChron()` is a wrapper for multiple plotting functions, and has a lot of options, which probably require tinkering to produce a nice plot. See all the options by running `?plotChron`

## Mapping the age ensemble to the paleoData measurements

The ensemble chronology in a chronModel may or may not have values corresponding to the paleoclimatic or paleoenvironmental measurements in paleoData. To map the model ensemble values to a measurement table in paleoData, use

```{r}
hulu = mapAgeEnsembleToPaleoData(hulu,age.var = "ageEnsemble",which.pmt = 2)
```

Let's take a look at the this timeseries.

First we're going to pull out the age ensemble and d18O data for future reference. The `selectData()` function makes this easy.

```{r}
hulu.ae <- selectData(hulu,varName = "ageEnsemble",which.mt = 2)
hulu.d18O<- selectData(hulu,varName = "d18O",which.mt = 2)
```


#This might be a good time to take a peak at the data, lets plot the ensemble of lines for these

Here we will just plot 50 the data with 50 of its ensemble members.   
```{r}
hulu.ts.plot = plotTimeseriesEnsLines(X = hulu.ae,Y = hulu.d18O,alp = 0.01,maxPlotN = 50,color = "blue")
hulu.ts.plot
```

We can also plot this as a ribbon plot of quantiles

```{r}
hulu.ts.plot = plotTimeseriesEnsRibbons(X = hulu.ae,Y = hulu.d18O,nbins = 1000)+xlim(c(35000,75000))
hulu.ts.plot
```

Or a combination of the two with the "add.to.plot option"

```{r}
hulu.ts.plot <- plotTimeseriesEnsLines(X = hulu.ae,Y = hulu.d18O,alp = 0.1,maxPlotN = 10,color = "red",add.to.plot = hulu.ts.plot)+ggtitle("Hulu Cave d18O")
hulu.ts.plot
```

## Let's compare these data to the GISP2 ice core.
Let's compare it to a nearby ice core.

```{r}
gisp2 <- readLipd(system.file("extdata", "GISP2.Ally.2000.lpd", package = "geoChronR"))
```

This is an ice core, so the chronology is not based on radiometric tie points. Let's use BAM (Banded Age Model) to estimate a 2% counting uncertainty on this. Here we specify all the parameters so it runs in non-interactive mode. 
```{r}
gisp2 = runBam(gisp2,which.paleo = 1, which.pmt = 1,which.chron = 1,which.model = 1,ens.number = 1, makeNew = T,nens = 1000,model = list(name = "poisson",param = 0.02, resize = 0, ns = 1000))
```

We can now take a look into the bowels of that LiPD object and see that it has an ageEnsemble. Because BAM runs off of the data in the paleo measurementTable, it puts the ageEnsemble straight into the paleoData, and we don't need to run `mapAgeEnsembleToPaleoData()'.

```{r}
gisp2.d18O <- selectData(gisp2,varName = "temp")

gisp2.ens <- selectData(gisp2,varName = "yearEnsemble")

gisp2.ens$values[1:10,1:5]

```

Yep - that's the first 10 entries of the first five age ensembles.

Hey, it looks like those might be in calendar years instead of years BP. Let's check the units

```{r}
gisp2.ens$units
```
yep. We'd better convert it to BP for comparison with Hulu.

```{r}
gisp2.ens <- convertAD2BP(gisp2.ens)
```


```{r}
gisp2.ts.plot <- plotTimeseriesEnsRibbons(X = gisp2.ens,Y = gisp2.d18O,nbins = 500) %>% 
  plotTimeseriesEnsLines(X = gisp2.ens,Y = gisp2.d18O,maxPlotN = 5,color = "red",alp = .1)+
  ggtitle("GISP2 temperature")



print(gisp2.ts.plot)

```

Let's compare the overlapping sections of these records, from about 

```{r}
library(gridExtra)
library(ggplot2)
overlap <- c(36000,50000)
gisp2.ts.plot+xlim(overlap)
grid.arrange(grobs = list(gisp2.ts.plot+xlim(overlap),hulu.ts.plot+xlim(overlap)),nrow = 2)


corout <- corEns(gisp2.ens,gisp2.d18O,hulu.ae,hulu.d18O,binstep = 1000,max.ens = 100)
plotCorrEns(corout$cor.df,corStats = corout$corStats)

```




## Vignette Info

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

output: 
rmarkdown::html_vignette:
css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

output:
rmarkdown::html_vignette:
fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
