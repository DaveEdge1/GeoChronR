---
title: "ensemble PCA example"
author: "Nick McKay"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ensemble PCA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r,echo = FALSE}
knitr::opts_chunk$set(fig.retina = 2, fig.width = 8,fig.height = 6) 
knitr::opts_knit$set(progress = FALSE,verbose = FALSE,width = 150)
options(width = 150)

```


  
```{r,results="hide",fig.keep="all"}

library(lipdR)
library(geoChronR)
library(magrittr)
library(dplyr)
```
  
load in all of the files in the "Arctic2kLipds" folder

```{r}
FD <- readLipd("~/Dropbox/LiPD/arcIso2k/") 
```
##Grab the age ensembles for each record. 
We need to "map"" the age ensembles to paleo for all of these datasets. In this case we're going to specify that all of the age ensembles are named "ageEnsemble", and that they don't have a depth varaible because they're layer counted.
```{r,results="hide"}
FD2 = sapply(FD,mapAgeEnsembleToPaleoData,strictSearch = TRUE,age.var = "ageEnsemble",depth.var = NULL )
```

Now extract all the "timeseries" into at "TS object" that will facilitate working with multiple records.
```{r}
TS = extractTs(FD2)
```

OK. Let's filter the timeseries object, pulling all the d18O data.

```{r,results="hide"}
d18OTS = filterTs(TS,"paleoData_variableName == d18O")
```

Now, we'll bin 
```{r,results="hide"}
binned.TS = binTs(d18OTS,binvec = seq(1400,2000,by=5),na.col.rm = T)
```

And calculate the ensemble PCA, this time using a covariance matrix
```{r,results="hide"}
pcout = pcaEns(binned.TS,PCAtype = "cov")
```


```{r}
plotPCA = plotPcaEns(pcout,TS = d18OTS,map.type = "line",projection = "stereo",boundcirc = T,restrict.map.range = T,f=.2)
```



