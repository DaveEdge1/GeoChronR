<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ensemble PCA • geoChronR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Ensemble PCA">
<meta property="og:description" content="geoChronR">
<meta property="og:image" content="https://nickmckay.github.io/geoChronR/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geoChronR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.14</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Getting Started With geoChronR</li>
    <li>
      <a href="../articles/Introduction.html">Introduction to geoChronR</a>
    </li>
    <li>
      <a href="../articles/correlation.html">Ensemble Correlation</a>
    </li>
    <li>
      <a href="../articles/regression.html">Ensemble Regression</a>
    </li>
    <li>
      <a href="../articles/spectral_analysis.html">Spectral Analysis</a>
    </li>
    <li>
      <a href="../articles/PCA.html">Ensemble Principal Components Analysis</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Tutorials highlighting additional geoChronR use cases</li>
    <li>
      <a href="../articles/oxCal.html">Introduction to oxCal in geoChronR</a>
    </li>
    <li>
      <a href="../articles/PlotTimeseriesStack.html">Plot a stack of timeseries</a>
    </li>
    <li>
      <a href="../articles/TsFilteringAndMapping.html">Dataset filtering and mapping (with iso2k)</a>
    </li>
    <li>
      <a href="../articles/tidyIso2k.html">Tidy filtering and mapping (with tidyverse &amp; iso2k)</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nickmckay/GeoChronR/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="PCA_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Ensemble PCA</h1>
                        <h4 class="author">Nick McKay</h4>
            
            <h4 class="date">2021-10-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nickmckay/GeoChronR/blob/master/vignettes/PCA.Rmd"><code>vignettes/PCA.Rmd</code></a></small>
      <div class="hidden name"><code>PCA.Rmd</code></div>

    </div>

    
    
<div id="table-of-contents" class="section level1">
<h1 class="hasAnchor">
<a href="#table-of-contents" class="anchor"></a>Table of contents</h1>
<ol style="list-style-type: decimal">
<li><a href="Introduction.html">Introduction to geoChronR</a></li>
<li><a href="correlation.html">Age-uncertain correlation</a></li>
<li><a href="regression.html">Age-uncertain regression and calibration-in-time</a></li>
<li><a href="spectral.html">Age-uncertain spectral analysis</a></li>
<li><a href="pca.html"><strong>Age-uncertain PCA analysis</strong></a></li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">lipdR</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nickmckay/GeoChronR">geoChronR</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="age-uncertain-principal-component-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#age-uncertain-principal-component-analysis" class="anchor"></a>Age-Uncertain Principal Component Analysis</h1>
<p>This vignette showcases the ability to perform principal component analysis (PCA, also known as empirical orthogonal function (EOF) analysis. Data are from the <a href="https://www.nature.com/articles/sdata201426">Arctic 2k</a> compilation, which we load here:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R">  <span class="va">FD</span> <span class="op">&lt;-</span> <span class="fu">lipdR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lipdR/man/readLipd.html">readLipd</a></span><span class="op">(</span><span class="st">"http://lipdverse.org/geoChronR-examples/arc2k/Arctic2k.zip"</span><span class="op">)</span> </code></pre></div>
<pre><code>## [1] "reading: Arc-Agassiz.Vinther.2008.lpd"
## [1] "reading: Arc-Austfonna.Isaksson.2005.lpd"
## [1] "reading: Arc-CampCentury.Fisher.1969.lpd"
## [1] "reading: Arc-Crete.Vinther.2010.lpd"
## [1] "reading: Arc-DevonIceCap.Fisher.1983.lpd"
## [1] "reading: Arc-Dye.Vinther.2010.lpd"
## [1] "reading: Arc-GISP2.Grootes.1997.lpd"
## [1] "reading: Arc-GRIP.Vinther.2010.lpd"
## [1] "reading: Arc-Hvtrvatn.Larsen.2011.lpd"
## [1] "reading: Arc-LakeC2.Lamoureux.1996.lpd"
## [1] "reading: Arc-LakeDonardBaffinIsland.Moore.2001.lpd"
## [1] "reading: Arc-LakeLehmilampi.Haltia-Hovi.2007.lpd"
## [1] "reading: Arc-LakeNataujrvi.Ojala.2005.lpd"
## [1] "reading: Arc-LowerMurrayLake.Cook.2008.lpd"
## [1] "reading: Arc-NGRIP1.Vinther.2006.lpd"
## [1] "reading: Arc-NGTB16.Schwager.1998.lpd"
## [1] "reading: Arc-NGTB18.Schwager.1998.lpd"
## [1] "reading: Arc-NGTB21.Schwager.1998.lpd"
## [1] "reading: Arc-Renland.Vinther.2008.lpd"</code></pre>
<div id="make-a-map" class="section level2">
<h2 class="hasAnchor">
<a href="#make-a-map" class="anchor"></a>Make a map</h2>
<p>First, let’s take a quick look at where these records are located. geoChronR’s <code>mapLipd</code> function can create quick maps:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mapLipd.html">mapLipd</a></span><span class="op">(</span><span class="va">FD</span>,map.type <span class="op">=</span> <span class="st">"line"</span>,projection <span class="op">=</span> <span class="st">"stereo"</span>,f <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></code></pre></div>
<p><img src="PCA_files/figure-html/unnamed-chunk-4-1.png" width="768"></p>
<p>More map projections are available too. A list is available here: <code>?mapproject</code></p>
</div>
<div id="prepare-the-data-for-pca" class="section level2">
<h2 class="hasAnchor">
<a href="#prepare-the-data-for-pca" class="anchor"></a>Prepare the data for PCA</h2>
<div id="grab-the-age-ensembles-for-each-record-" class="section level3">
<h3 class="hasAnchor">
<a href="#grab-the-age-ensembles-for-each-record-" class="anchor"></a>Grab the age ensembles for each record.</h3>
<p>Now we need to “map” (I know, a different kind of mapping) the age ensembles to paleo for all of these datasets. We’ll use purrr::map for this, but you could also do it with sapply(). In this case we’re going to specify that all of the age ensembles are named “ageEnsemble”, and that they don’t have a depth variable because they’re layer counted.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">FD2</span> <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">FD</span>,
                 <span class="va">mapAgeEnsembleToPaleoData</span>,
                 strict.search <span class="op">=</span> <span class="cn">TRUE</span>,
                 age.var <span class="op">=</span> <span class="st">"ageEnsemble"</span>,
                 depth.var <span class="op">=</span> <span class="cn">NULL</span> <span class="op">)</span></code></pre></div>
<p>Now extract all the “timeseries” into at “TS object” that will facilitate working with multiple records.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">TS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lipdR/man/extractTs.html">extractTs</a></span><span class="op">(</span><span class="va">FD2</span><span class="op">)</span></code></pre></div>
<p>and filter the TS object to only include variables that have been interpreted as temperature. Here we’ll use <code><a href="https://rdrr.io/pkg/lipdR/man/filterTs.html">lipdR::filterTs</a></code> to filter the TS object.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">TS.filtered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lipdR/man/filterTs.html">filterTs</a></span><span class="op">(</span><span class="va">TS</span>,<span class="st">"interpretation1_variable == T"</span><span class="op">)</span></code></pre></div>
<p>OK, let’s make a quick plot stack to see what we’re dealing with.</p>
<p>The <code><a href="https://rdrr.io/pkg/lipdR/man/tidyTs.html">lipdR::tidyTs</a></code> function will convert a TS into a long, “tidy” data.frame, where each observation has a row in a data.frame. This can be verbose, but is also useful for data analysis in the tidyverse framework.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tidyDf</span> <span class="op">&lt;-</span> <span class="fu">lipdR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lipdR/man/tidyTs.html">tidyTs</a></span><span class="op">(</span><span class="va">TS.filtered</span>,age.var <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></code></pre></div>
<p>A tidy data.frame is also the input for the <code>plotTimeseriesStack</code> function in geoChronR.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotTimeseriesStack.html">plotTimeseriesStack</a></span><span class="op">(</span><span class="va">tidyDf</span>, 
                    color.var <span class="op">=</span> <span class="st">"paleoData_variableName"</span>, 
                    color.ramp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"DarkBlue"</span>,<span class="st">"Orange"</span>,<span class="st">"Black"</span>,<span class="st">"Dark Green"</span><span class="op">)</span>,
                    line.size <span class="op">=</span> <span class="fl">.1</span>, 
                    fill.alpha <span class="op">=</span> <span class="fl">.05</span>,
                    lab.size <span class="op">=</span> <span class="fl">2</span>,
                    lab.space <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<p><img src="PCA_files/figure-html/unnamed-chunk-9-1.png" width="768"></p>
<p>Now bin all the data in the TS from 1400 to 2000, an interval of pretty good data coverage, into 5 year bins.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">binned.TS</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/binTs.html">binTs</a></span><span class="op">(</span><span class="va">TS.filtered</span>,bin.vec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1400</span>,<span class="fl">2000</span>,by<span class="op">=</span><span class="fl">5</span><span class="op">)</span>,time.var <span class="op">=</span> <span class="st">"ageEnsemble"</span><span class="op">)</span></code></pre></div>
<p>We’re now ready to calculate the PCA!</p>
</div>
</div>
<div id="calculate-the-ensemble-pca" class="section level2">
<h2 class="hasAnchor">
<a href="#calculate-the-ensemble-pca" class="anchor"></a>Calculate the ensemble PCA</h2>
<p>Calculate PCA on each ensemble member:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pcout</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pcaEns.html">pcaEns</a></span><span class="op">(</span><span class="va">binned.TS</span><span class="op">)</span></code></pre></div>
<p>That was easy (because of all the work we did beforehand). But before we look at the results let’s take a look at a scree plot to get a sense of how many significant components we should expect.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotScreeEns.html">plotScreeEns</a></span><span class="op">(</span><span class="va">pcout</span><span class="op">)</span></code></pre></div>
<p><img src="PCA_files/figure-html/unnamed-chunk-12-1.png" width="768"></p>
<p>It looks like the first two components, shown in black with gray uncertainty shading, stand out above the null model (in red), but the third and beyond look marginal to insignficant. Let’s focus on the first two components.</p>
<div id="plot-the-ensemble-pca-results" class="section level3">
<h3 class="hasAnchor">
<a href="#plot-the-ensemble-pca-results" class="anchor"></a>Plot the ensemble PCA results</h3>
<p>Now let’s visualize the results. The <code>plotPcaEns</code> function will create multiple diagnostic figures of the results, and stitch them together.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plotPCA</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/plotPcaEns.html">plotPcaEns</a></span><span class="op">(</span><span class="va">pcout</span>,TS <span class="op">=</span> <span class="va">TS.filtered</span>,map.type <span class="op">=</span> <span class="st">"line"</span>,projection <span class="op">=</span> <span class="st">"stereo"</span>,bound.circ <span class="op">=</span> <span class="cn">T</span>,restrict.map.range <span class="op">=</span> <span class="cn">T</span>,f<span class="op">=</span><span class="fl">.1</span>,legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">.6</span><span class="op">)</span>,which.pcs <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,which.leg <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="PCA_files/figure-html/unnamed-chunk-13-1.png" width="768"></p>
<p>Nice! A summary plot that combines the major features is produced, but all of the components, are included in the “plotPCA” list that was exported.</p>
<p>For comparison with other datasets it can be useful to export quantile timeseries shown in the figures. <code><a href="../reference/plotTimeseriesEnsRibbons.html">plotTimeseriesEnsRibbons()</a></code> can optionally be used to export the data rather than plotting them. The following will export the PC1 timeseries:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">quantileData</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plotTimeseriesEnsRibbons.html">plotTimeseriesEnsRibbons</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">pcout</span><span class="op">$</span><span class="va">age</span>,Y <span class="op">=</span> <span class="va">pcout</span><span class="op">$</span><span class="va">PCs</span><span class="op">[</span>,<span class="fl">1</span>,<span class="op">]</span>,export.quantiles <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">quantileData</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 200 x 6
##     ages `0.025`   `0.25`   `0.5` `0.75` `0.975`
##    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
##  1 1408. -0.0641  0.0446  0.103   0.160    0.270
##  2 1410.  0.0159  0.0949  0.134   0.175    0.246
##  3 1413.  0.0524  0.124   0.169   0.205    0.284
##  4 1416.  0.101   0.174   0.209   0.238    0.287
##  5 1419.  0.0896  0.143   0.174   0.200    0.250
##  6 1422. -0.0149  0.0562  0.0909  0.129    0.206
##  7 1425. -0.0380  0.0172  0.0394  0.0679   0.121
##  8 1428. -0.0976 -0.0291  0.00767 0.0436   0.112
##  9 1431. -0.0716 -0.0179  0.0194  0.0567   0.124
## 10 1434. -0.0666  0.00276 0.0372  0.0807   0.142
## # … with 190 more rows</code></pre>
</div>
</div>
<div id="ensemble-pca-take-two---using-a-covariance-matrix-" class="section level2">
<h2 class="hasAnchor">
<a href="#ensemble-pca-take-two---using-a-covariance-matrix-" class="anchor"></a>Ensemble PCA take two - using a covariance matrix.</h2>
<p>Let’s repeat much of this analysis, but this time we’re only going to analyze the <span class="math inline">\(\delta^{18}O\)</span> data, keep them in their native values, and use a covariance matrix in the PCA analysis.</p>
<p>First, it looks like let’s look at all the names in the TS</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">var.names</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pullTsVariable.html">pullTsVariable</a></span><span class="op">(</span><span class="va">TS</span>, <span class="st">"variableName"</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning in pullTsVariable(TS, "variableName"): Couldn't find exact match for
## 'variableName', using paleoData_variableName instead.</code></pre>
<p>Oops - looks like we didn’t use quite the correct name. Next time use:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">var.names</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pullTsVariable.html">pullTsVariable</a></span><span class="op">(</span><span class="va">TS</span>, <span class="st">"paleoData_variableName"</span><span class="op">)</span></code></pre></div>
<p>and take a look at the unique variableNames in the TS</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">var.names</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "d18O"                    "year"                   
## [3] "ageEnsemble"             "thickness"              
## [5] "X_radiograph_dark_layer" "massacum"</code></pre>
<p>OK. Let’s filter the timeseries again, this time pulling all the <span class="math inline">\(\delta^{18}O\)</span> data.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d18OTS</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lipdR/man/filterTs.html">filterTs</a></span><span class="op">(</span><span class="va">TS</span>,<span class="st">"paleoData_variableName == d18O"</span><span class="op">)</span></code></pre></div>
<p>And we’ll tidy up the data for a plotStack</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tidyd18O</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lipdR/man/tidyTs.html">tidyTs</a></span><span class="op">(</span><span class="va">d18OTS</span>,age.var <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></code></pre></div>
<p>Before plotting, let’s do some tidyverse gymnastics to reorder the data by the length of the observations</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#arrange the tidy dataframe by record length</span>
<span class="va">tidyd18O</span> <span class="op">&lt;-</span> <span class="va">tidyd18O</span> <span class="op">%&gt;%</span> <span class="co">#use the magrittr pipe for clarity</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">paleoData_TSid</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#group the data by column</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#create a new column for the duration</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">duration</span><span class="op">)</span> <span class="co"># and arrange the data by duration</span></code></pre></div>
<p>Again we’ll use <code>plotTimeseriesStack</code> to show all the data, now nicely arranged.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotTimeseriesStack.html">plotTimeseriesStack</a></span><span class="op">(</span><span class="va">tidyd18O</span>, 
                    color.var <span class="op">=</span> <span class="st">"paleoData_variableName"</span>, <span class="co"># Color the data by the variable name (all the same in the case)</span>
                    color.ramp <span class="op">=</span> <span class="st">"DarkBlue"</span>, <span class="co">#colors to use</span>
                    line.size <span class="op">=</span> <span class="fl">.1</span>, 
                    fill.alpha <span class="op">=</span> <span class="fl">.05</span>,
                    lab.size <span class="op">=</span> <span class="fl">2</span>,
                    lab.space <span class="op">=</span> <span class="fl">2</span>,
                    lab.buff <span class="op">=</span> <span class="fl">0.03</span><span class="op">)</span></code></pre></div>
<p><img src="PCA_files/figure-html/unnamed-chunk-21-1.png" width="768"></p>
<p>Well that sure is nice and tidy. Again, it looks like binning from 1400-2000 will give us good data coverage.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">binned.TS2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/binTs.html">binTs</a></span><span class="op">(</span><span class="va">d18OTS</span>,bin.vec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1400</span>,<span class="fl">2000</span>,by<span class="op">=</span><span class="fl">5</span><span class="op">)</span>,na.col.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></code></pre></div>
<p>And calculate the ensemble PCA, this time using a covariance matrix. By using a covariance, we’ll allow records that have larger variability in <span class="math inline">\(\delta^{18}O\)</span> to influence the PCA more, and those that have little variability will have little impact. This may or may not be a good idea, but it’s an important option to consider when possible.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pcout2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pcaEns.html">pcaEns</a></span><span class="op">(</span><span class="va">binned.TS2</span>,pca.type <span class="op">=</span> <span class="st">"cov"</span><span class="op">)</span></code></pre></div>
<p>Once again, let’s take a look at the scree plot:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotScreeEns.html">plotScreeEns</a></span><span class="op">(</span><span class="va">pcout2</span><span class="op">)</span></code></pre></div>
<p><img src="PCA_files/figure-html/unnamed-chunk-24-1.png" width="384"></p>
<pre><code>Once again, the first two components look good, but the third also looks to be likely above the 95% significance level, so let's include the third PC in our plot this time as well. 


```r
plotPCA2 &lt;-  plotPcaEns(pcout2,
                        TS = d18OTS,
                        which.pcs = 1:3,  
                        map.type = "line",
                        projection = "stereo",
                        bound.circ = T,
                        restrict.map.range = T,
                        f=.2)</code></pre>
<p><img src="PCA_files/figure-html/unnamed-chunk-25-1.png" width="768"></p>
<p>Using only the <span class="math inline">\(\delta^{18}O\)</span> data and a covariance matrix, we get somewhat different results. The first PC timeseries looks similar to the first one, but the spatial pattern is somewhat difference, with stronger loadings in the northeast. The second PC looks to be a new pattern, although the third resembles PC2 from the first analysis.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Nicholas McKay, Julien Emile-Geay, Deborah Khider.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '21c1c99b27cf4a45be9f8db70183f6c7',
    indexName: 'lipd-utilities',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
